<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConexyTask - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</title>
    <style>
        /* ==== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ==== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 20px;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
            animation: slideIn 0.8s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-30px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #efe;
            color: #3c3;
            border-left: 4px solid #3c3;
        }
        .message.error {
            background: #fee;
            color: #c33;
            border-left: 4px solid #c33;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%,100% { transform: translateX(0); }
            25%     { transform: translateX(-10px); }
            75%     { transform: translateX(10px); }
        }

        /* –ü–∞–Ω–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è */
        .connection-panel {
            background: #e6f7ff;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #1890ff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .connection-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .api-badge {
            background: #1890ff;
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            font-family: monospace;
        }
        .status-badge {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-change-url {
            background: #1890ff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: 0.3s;
        }
        .btn-change-url:hover {
            background: #096dd9;
            transform: translateY(-2px);
        }

        /* –§–æ—Ä–º–∞ */
        .form-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 0.95em;
            transition: all 0.3s;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
            transform: translateY(-2px);
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102,126,234,0.4);
        }
        .btn-danger {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .btn-edit {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        .btn-timer {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: white;
        }
        .btn-fullscreen {
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
            color: white;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á */
        .tasks-container {
            margin-top: 20px;
        }
        .task-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            animation: slideInRight 0.5s;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .task-card.deleting {
            animation: slideOut 0.5s forwards;
        }
        @keyframes slideOut {
            to { opacity: 0; transform: translateX(-100px); height: 0; margin: 0; padding: 0; }
        }
        .task-card.completed {
            opacity: 0.7;
            background: #f0f0f0;
        }
        .task-card.completed .task-title,
        .task-card.completed .task-description {
            text-decoration: line-through;
            color: #999;
        }

        .task-content {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }
        .task-checkbox {
            width: 28px;
            height: 28px;
            min-width: 28px;
            border: 3px solid #667eea;
            border-radius: 50%;
            cursor: pointer;
            transition: 0.3s;
            background: white;
            flex-shrink: 0;
        }
        .task-checkbox:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(102,126,234,0.2);
        }
        .task-checkbox.checked {
            background: #667eea;
            border-color: #667eea;
            position: relative;
        }
        .task-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            font-weight: bold;
        }

        .task-info {
            flex: 1;
            min-width: 0;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
            flex-wrap: wrap;
        }
        .task-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
            word-break: break-word;
        }
        .task-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .task-description {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.6;
            word-break: break-word;
        }
        .task-timer {
            margin-top: 10px;
            padding: 10px;
            background: #fff9e6;
            border-radius: 8px;
            border-left: 4px solid #fda085;
        }
        .timer-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #fda085;
            text-align: center;
            margin-bottom: 10px;
            font-family: monospace;
        }
        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .timer-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .timer-btn-start { background: #4facfe; color: white; }
        .timer-btn-pause  { background: #fda085; color: white; }
        .timer-btn-stop   { background: #f5576c; color: white; }

        /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä */
        .fullscreen-timer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            animation: fadeIn 0.5s;
        }
        .fullscreen-content {
            max-width: 800px;
            width: 100%;
            text-align: center;
        }
        .fullscreen-task-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #f6d365;
            word-break: break-word;
        }
        .fullscreen-task-description {
            font-size: 1.2rem;
            margin-bottom: 40px;
            opacity: 0.9;
            word-break: break-word;
        }
        .fullscreen-timer-display {
            font-size: 8rem;
            font-weight: 800;
            font-family: monospace;
            margin-bottom: 50px;
            color: #a8e6cf;
            text-shadow: 0 0 20px rgba(168,230,207,0.5);
            line-height: 1;
        }
        .fullscreen-controls {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .fullscreen-btn {
            padding: 16px 32px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fullscreen-btn-pause {
            background: #4facfe;
            color: white;
        }
        .fullscreen-btn-stop {
            background: #f5576c;
            color: white;
        }
        .fullscreen-btn-complete {
            background: #00b894;
            color: white;
        }
        .fullscreen-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(0,0,0,0.4);
        }
        .fullscreen-back {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 40px;
            font-size: 1.1rem;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .fullscreen-back:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            color: #667eea;
        }
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: #000; }

        .timer-presets {
            display: grid;
            grid-template-columns: repeat(3,1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .timer-preset-btn {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
        }
        .timer-preset-btn:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            h1 { font-size: 1.5em; }
            .fullscreen-task-title { font-size: 1.8rem; }
            .fullscreen-timer-display { font-size: 5rem; }
            .fullscreen-btn { padding: 12px 24px; font-size: 1rem; }
            .fullscreen-back { top: 15px; left: 15px; padding: 8px 16px; }
            .timer-presets { grid-template-columns: repeat(2,1fr); }
        }
        @media (max-width: 400px) {
            .fullscreen-timer-display { font-size: 3.5rem; }
        }
    </style>
</head>
<body>
<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á) -->
<div id="mainContainer" class="container">
    <h1>‚ú® ConexyTask ‚ú®</h1>

    <!-- –ü–∞–Ω–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API -->
    <div class="connection-panel">
        <div class="connection-info">
            <span class="api-badge" id="apiUrlDisplay">http://localhost:5221</span>
            <span class="status-badge" id="connectionStatus">
                    <span id="statusIcon">üîÑ</span>
                    <span id="statusText">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </span>
        </div>
        <button class="btn-change-url" onclick="changeApiUrl()">üîó –ò–∑–º–µ–Ω–∏—Ç—å URL</button>
    </div>

    <div id="message" class="message"></div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="form-container">
        <form id="taskForm">
            <div class="form-group">
                <label for="taskName">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
                <input type="text" id="taskName" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...">
            </div>
            <div class="form-group">
                <label for="taskDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="taskDescription" name="description" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary" id="submitBtn">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</button>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    <div class="tasks-container">
        <div id="tasksList" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</div>
    </div>
</div>

<!-- ========== –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–´–ô –¢–ê–ô–ú–ï–† ========== -->
<div id="fullscreenTimer" class="fullscreen-timer">
    <button class="fullscreen-back" onclick="hideFullscreenTimer()">
        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
    </button>
    <div class="fullscreen-content">
        <div id="fullscreenTaskTitle" class="fullscreen-task-title">–ó–∞–¥–∞—á–∞</div>
        <div id="fullscreenTaskDesc" class="fullscreen-task-description"></div>
        <div id="fullscreenTimerDisplay" class="fullscreen-timer-display">00:00</div>
        <div class="fullscreen-controls">
            <button id="fullscreenPauseBtn" class="fullscreen-btn fullscreen-btn-pause" onclick="fullscreenTogglePause()">
                ‚è∏Ô∏è –ü–∞—É–∑–∞
            </button>
            <button class="fullscreen-btn fullscreen-btn-stop" onclick="fullscreenStopTimer()">
                ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
            </button>
            <button class="fullscreen-btn fullscreen-btn-complete" onclick="fullscreenCompleteTask()">
                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É
            </button>
        </div>
    </div>
</div>

<!-- ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¢–ê–ô–ú–ï–†–ê ========== -->
<div id="timerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚è±Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä</h2>
            <span class="close" onclick="closeTimerModal()">&times;</span>
        </div>
        <div class="form-group">
            <label>–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)</label>
            <input type="number" id="timerMinutes" class="timer-input" min="1" max="999" value="25">
        </div>
        <div class="timer-presets">
            <button type="button" class="timer-preset-btn" onclick="setTimerPreset(15)">15 –º–∏–Ω</button>
            <button type="button" class="timer-preset-btn" onclick="setTimerPreset(25)">25 –º–∏–Ω</button>
            <button type="button" class="timer-preset-btn" onclick="setTimerPreset(30)">30 –º–∏–Ω</button>
            <button type="button" class="timer-preset-btn" onclick="setTimerPreset(45)">45 –º–∏–Ω</button>
            <button type="button" class="timer-preset-btn" onclick="setTimerPreset(60)">60 –º–∏–Ω</button>
            <button type="button" class="timer-preset-btn" onclick="setTimerPreset(90)">90 –º–∏–Ω</button>
        </div>
        <button type="button" class="btn btn-primary" onclick="startTimerFromModal()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–∞–π–º–µ—Ä</button>
    </div>
</div>

<!-- ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–ú–ï–ù–´ URL ========== -->
<div id="apiUrlModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üîó –ò–∑–º–µ–Ω–∏—Ç—å URL API</h2>
            <span class="close" onclick="closeApiUrlModal()">&times;</span>
        </div>
        <div class="form-group">
            <label>URL API</label>
            <input type="text" id="apiUrlInput" class="timer-input" value="http://localhost:5221">
        </div>
        <div style="margin: 15px 0;">
            <strong>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</strong>
            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
                <button type="button" class="timer-preset-btn" onclick="setApiUrlPreset('http://localhost:5221')">–õ–æ–∫–∞–ª—å–Ω—ã–π (5221)</button>
                <button type="button" class="timer-preset-btn" onclick="setApiUrlPreset('http://localhost:8080')">Docker (8080)</button>
            </div>
        </div>
        <button type="button" class="btn btn-primary" onclick="saveApiUrl()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" class="btn" onclick="closeApiUrlModal()" style="margin-top: 10px; background: #f0f0f0;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
    // API
    function getApiBaseUrl() {
        const saved = localStorage.getItem('apiUrl');
        return saved || 'http://localhost:5221';
    }
    let API_BASE_URL = getApiBaseUrl();
    let API_URL = `${API_BASE_URL}/api/tasks`;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á
    let editingTaskId = null;
    let completedTasks = JSON.parse(localStorage.getItem('completedTasks') || '{}');
    let timers = JSON.parse(localStorage.getItem('taskTimers') || '{}');      // { taskId: { total, remaining, running } }
    let timerIntervals = {};  // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è setInterval –∫–∞–∂–¥–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞

    // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
    let activeFullscreenTaskId = null;

    // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
    document.addEventListener('DOMContentLoaded', () => {
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π URL
        document.getElementById('apiUrlDisplay').textContent = API_BASE_URL;
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º, –µ—Å–ª–∏ –±—ã–ª –∞–∫—Ç–∏–≤–µ–Ω
        restoreFullscreenTimer();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
        loadTasks();
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö —Ç–∞–π–º–µ—Ä–æ–≤
        Object.keys(timers).forEach(taskId => {
            if (timers[taskId].running) {
                startTimerInterval(taskId);
            }
        });
    });

    // –ó–∞–ø—Ä–æ—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // ==================== API ====================
    async function loadTasks() {
        try {
            const res = await fetch(API_URL);
            if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ ${res.status}`);
            const tasks = await res.json();
            displayTasks(tasks);
            checkConnection();
        } catch (err) {
            document.getElementById('tasksList').innerHTML =
                `<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${err.message}<br>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.</div>`;
            checkConnection();
        }
    }

    async function createTask(name, description) {
        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description })
            });
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
            showMessage('‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
            document.getElementById('taskForm').reset();
            loadTasks();
        } catch (err) {
            showMessage(`‚ùå ${err.message}`, 'error');
        }
    }

    async function updateTask(id, name, description) {
        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description })
            });
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
            showMessage('‚úÖ –ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            editingTaskId = null;
            document.getElementById('taskForm').reset();
            document.getElementById('submitBtn').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É';
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('edit-mode'));
            loadTasks();
        } catch (err) {
            showMessage(`‚ùå ${err.message}`, 'error');
        }
    }

    async function deleteTask(id) {
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
        const card = document.getElementById(`task-${id}`);
        card?.classList.add('deleting');

        delete completedTasks[id];
        delete timers[id];
        if (timerIntervals[id]) clearInterval(timerIntervals[id]);
        delete timerIntervals[id];
        localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
        localStorage.setItem('taskTimers', JSON.stringify(timers));

        try {
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
            setTimeout(() => {
                showMessage('‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
                loadTasks();
            }, 500);
        } catch (err) {
            card?.classList.remove('deleting');
            showMessage(`‚ùå ${err.message}`, 'error');
        }
    }

    // ==================== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –ó–ê–î–ê–ß ====================
    function displayTasks(tasks) {
        const list = document.getElementById('tasksList');
        if (!tasks || tasks.length === 0) {
            list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìù</div><p>–ù–µ—Ç –∑–∞–¥–∞—á. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p></div>`;
            return;
        }

        list.innerHTML = tasks.map(task => {
            const isCompleted = completedTasks[task.id] || false;
            const timer = timers[task.id];
            const timerHtml = timer ? `
                    <div class="task-timer">
                        <div class="timer-display" id="timer-display-${task.id}">${formatTime(timer.remaining)}</div>
                        <div class="timer-controls">
                            <button class="timer-btn timer-btn-start" onclick="toggleTimer('${task.id}')" id="timer-toggle-${task.id}">
                                ${timer.running ? '‚è∏Ô∏è –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç'}
                            </button>
                            <button class="timer-btn timer-btn-stop" onclick="stopTimer('${task.id}')">‚èπÔ∏è –°—Ç–æ–ø</button>
                            <button class="timer-btn timer-btn-start" onclick="showFullscreenTimer('${task.id}')">üñ•Ô∏è –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
                        </div>
                    </div>
                ` : '';

            return `
                    <div class="task-card ${isCompleted ? 'completed' : ''}" id="task-${task.id}">
                        <div class="task-content">
                            <div class="task-checkbox ${isCompleted ? 'checked' : ''}" onclick="toggleComplete('${task.id}')"></div>
                            <div class="task-info">
                                <div class="task-header">
                                    <span class="task-title" id="title-${task.id}">${escapeHtml(task.name)}</span>
                                    <div class="task-actions">
                                        <button class="btn btn-timer" onclick="openTimerModal('${task.id}')">‚è±Ô∏è –¢–∞–π–º–µ—Ä</button>
                                        <button class="btn btn-edit" onclick="editTask('${task.id}', '${escapeHtml(task.name)}', '${escapeHtml(task.description)}')">‚úèÔ∏è</button>
                                        <button class="btn btn-danger" onclick="deleteTask('${task.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div class="task-description">${escapeHtml(task.description || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</div>
                                ${timerHtml}
                                <div class="task-id">ID: ${task.id}</div>
                            </div>
                        </div>
                    </div>
                `;
        }).join('');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== –ß–ï–ö–ë–û–ö–° (–í–´–ü–û–õ–ù–ï–ù–û) ====================
    function toggleComplete(taskId) {
        completedTasks[taskId] = !completedTasks[taskId];
        localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
        const card = document.getElementById(`task-${taskId}`);
        const chk = card?.querySelector('.task-checkbox');
        if (completedTasks[taskId]) {
            card?.classList.add('completed');
            chk?.classList.add('checked');
        } else {
            card?.classList.remove('completed');
            chk?.classList.remove('checked');
        }
    }

    // ==================== –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï ====================
    function editTask(id, name, desc) {
        editingTaskId = id;
        document.getElementById('taskName').value = name;
        document.getElementById('taskDescription').value = desc;
        document.getElementById('submitBtn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        document.querySelectorAll('.task-card').forEach(c => c.classList.remove('edit-mode'));
        document.getElementById(`task-${id}`)?.classList.add('edit-mode');
        document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
    }

    // ==================== –¢–ê–ô–ú–ï–†–´ (–õ–û–ì–ò–ö–ê) ====================
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function startTimerInterval(taskId) {
        if (timerIntervals[taskId]) clearInterval(timerIntervals[taskId]);
        timerIntervals[taskId] = setInterval(() => {
            if (!timers[taskId] || !timers[taskId].running) {
                clearInterval(timerIntervals[taskId]);
                delete timerIntervals[taskId];
                return;
            }
            timers[taskId].remaining--;
            if (timers[taskId].remaining < 0) timers[taskId].remaining = 0;
            localStorage.setItem('taskTimers', JSON.stringify(timers));

            // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ
            const cardDisplay = document.getElementById(`timer-display-${taskId}`);
            if (cardDisplay) cardDisplay.textContent = formatTime(timers[taskId].remaining);

            // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –¥–∏—Å–ø–ª–µ–π, –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–µ–Ω —ç—Ç–æ—Ç —Ç–∞–π–º–µ—Ä
            if (activeFullscreenTaskId === taskId) {
                document.getElementById('fullscreenTimerDisplay').textContent = formatTime(timers[taskId].remaining);
            }

            // –í—Ä–µ–º—è –≤—ã—à–ª–æ
            if (timers[taskId].remaining <= 0) {
                stopTimer(taskId);
                showMessage('‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ!', 'success');
                if (Notification.permission === 'granted') {
                    new Notification('FlipTask', { body: '–í—Ä–µ–º—è –≤—ã—à–ª–æ!', icon: '‚è∞' });
                }
            }
        }, 1000);
    }

    function stopTimerInterval(taskId) {
        if (timerIntervals[taskId]) {
            clearInterval(timerIntervals[taskId]);
            delete timerIntervals[taskId];
        }
    }

    function toggleTimer(taskId) {
        if (!timers[taskId]) return;
        timers[taskId].running = !timers[taskId].running;
        localStorage.setItem('taskTimers', JSON.stringify(timers));
        if (timers[taskId].running) {
            startTimerInterval(taskId);
        } else {
            stopTimerInterval(taskId);
        }
        const btn = document.getElementById(`timer-toggle-${taskId}`);
        if (btn) btn.textContent = timers[taskId].running ? '‚è∏Ô∏è –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç';

        // –ï—Å–ª–∏ —ç—Ç–æ—Ç —Ç–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ, –æ–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –ø–∞—É–∑—ã
        if (activeFullscreenTaskId === taskId) {
            const fsPauseBtn = document.getElementById('fullscreenPauseBtn');
            fsPauseBtn.innerHTML = timers[taskId].running ? '‚è∏Ô∏è –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
            fsPauseBtn.className = timers[taskId].running ? 'fullscreen-btn fullscreen-btn-pause' : 'fullscreen-btn fullscreen-btn-pause';
        }
    }

    function stopTimer(taskId) {
        if (timers[taskId]) {
            delete timers[taskId];
            localStorage.setItem('taskTimers', JSON.stringify(timers));
            stopTimerInterval(taskId);
            // –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è —ç—Ç–æ–π –∑–∞–¥–∞—á–∏ ‚Äî –∑–∞–∫—Ä—ã—Ç—å –µ–≥–æ
            if (activeFullscreenTaskId === taskId) {
                hideFullscreenTimer();
            }
            loadTasks(); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –±–ª–æ–∫ —Ç–∞–π–º–µ—Ä–∞
        }
    }

    // ==================== –ú–û–î–ê–õ–ö–ê –¢–ê–ô–ú–ï–†–ê ====================
    let currentTimerTaskId = null;
    function openTimerModal(taskId) {
        currentTimerTaskId = taskId;
        document.getElementById('timerModal').style.display = 'block';
    }
    function closeTimerModal() {
        document.getElementById('timerModal').style.display = 'none';
        currentTimerTaskId = null;
    }
    function setTimerPreset(minutes) {
        document.getElementById('timerMinutes').value = minutes;
    }
    function startTimerFromModal() {
        const mins = parseInt(document.getElementById('timerMinutes').value);
        if (!mins || mins < 1) {
            showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω—É—Ç', 'error');
            return;
        }
        if (!currentTimerTaskId) {
            showMessage('–û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞', 'error');
            return;
        }
        const totalSeconds = mins * 60;
        timers[currentTimerTaskId] = {
            total: totalSeconds,
            remaining: totalSeconds,
            running: true
        };
        localStorage.setItem('taskTimers', JSON.stringify(timers));
        startTimerInterval(currentTimerTaskId);
        closeTimerModal();
        loadTasks();
        // –û—Ç–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
        showFullscreenTimer(currentTimerTaskId);
        showMessage(`–¢–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${mins} –º–∏–Ω`, 'success');
    }

    // ==================== –ü–û–õ–ù–û–≠–ö–†–ê–ù–ù–´–ô –†–ï–ñ–ò–ú ====================
    function showFullscreenTimer(taskId) {
        const taskCard = document.getElementById(`task-${taskId}`);
        if (!taskCard) return;
        const title = document.getElementById(`title-${taskId}`)?.textContent || '–ó–∞–¥–∞—á–∞';
        const desc = document.getElementById(`desc-${taskId}`)?.textContent || '';

        activeFullscreenTaskId = taskId;
        document.getElementById('fullscreenTaskTitle').textContent = title;
        document.getElementById('fullscreenTaskDesc').textContent = desc;

        if (timers[taskId]) {
            document.getElementById('fullscreenTimerDisplay').textContent = formatTime(timers[taskId].remaining);
            const pauseBtn = document.getElementById('fullscreenPauseBtn');
            pauseBtn.innerHTML = timers[taskId].running ? '‚è∏Ô∏è –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
        } else {
            document.getElementById('fullscreenTimerDisplay').textContent = '00:00';
        }

        document.getElementById('fullscreenTimer').style.display = 'flex';
        document.getElementById('mainContainer').style.display = 'none';

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, —á—Ç–æ —ç—Ç–æ—Ç —Ç–∞–π–º–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
        localStorage.setItem('activeFullscreenTask', taskId);
    }

    function hideFullscreenTimer() {
        document.getElementById('fullscreenTimer').style.display = 'none';
        document.getElementById('mainContainer').style.display = 'block';
        localStorage.removeItem('activeFullscreenTask');
        activeFullscreenTaskId = null;
    }

    function restoreFullscreenTimer() {
        const savedTaskId = localStorage.getItem('activeFullscreenTask');
        if (savedTaskId && timers[savedTaskId]) {
            // –ü—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (—Ö–æ—Ç—è –±—ã –≤ —Ç–∞–π–º–µ—Ä–∞—Ö)
            showFullscreenTimer(savedTaskId);
        }
    }

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
    function fullscreenTogglePause() {
        if (activeFullscreenTaskId) {
            toggleTimer(activeFullscreenTaskId);
        }
    }

    function fullscreenStopTimer() {
        if (activeFullscreenTaskId) {
            stopTimer(activeFullscreenTaskId);
        }
    }

    function fullscreenCompleteTask() {
        if (activeFullscreenTaskId) {
            // –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é
            completedTasks[activeFullscreenTaskId] = true;
            localStorage.setItem('completedTasks', JSON.stringify(completedTasks));
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä
            stopTimer(activeFullscreenTaskId);
            // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É
            hideFullscreenTimer();
            loadTasks(); // –æ–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            showMessage('‚úÖ –ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!', 'success');
        }
    }

    // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï URL API ====================
    function changeApiUrl() {
        document.getElementById('apiUrlModal').style.display = 'block';
        document.getElementById('apiUrlInput').value = API_BASE_URL;
    }
    function closeApiUrlModal() {
        document.getElementById('apiUrlModal').style.display = 'none';
    }
    function setApiUrlPreset(url) {
        document.getElementById('apiUrlInput').value = url;
    }
    function saveApiUrl() {
        const newUrl = document.getElementById('apiUrlInput').value.trim();
        if (!newUrl.startsWith('http')) {
            showMessage('URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://', 'error');
            return;
        }
        localStorage.setItem('apiUrl', newUrl);
        API_BASE_URL = newUrl;
        API_URL = `${API_BASE_URL}/api/tasks`;
        document.getElementById('apiUrlDisplay').textContent = API_BASE_URL;
        closeApiUrlModal();
        showMessage('URL API –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        loadTasks();
    }

    // ==================== –ü–†–û–í–ï–†–ö–ê –°–û–ï–î–ò–ù–ï–ù–ò–Ø ====================
    async function checkConnection() {
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        try {
            const res = await fetch(API_URL);
            if (res.ok) {
                statusIcon.textContent = '‚úÖ';
                statusText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                statusIcon.textContent = '‚ö†Ô∏è';
                statusText.textContent = `–û—à–∏–±–∫–∞ ${res.status}`;
            }
        } catch {
            statusIcon.textContent = '‚ùå';
            statusText.textContent = '–ù–µ—Ç —Å–≤—è–∑–∏';
        }
    }

    // ==================== –°–û–û–ë–©–ï–ù–ò–Ø ====================
    function showMessage(text, type = 'success') {
        const msg = document.getElementById('message');
        msg.className = `message ${type}`;
        msg.textContent = text;
        msg.style.display = 'block';
        setTimeout(() => msg.style.display = 'none', 3000);
    }

    // ==================== –§–û–†–ú–ê ====================
    document.getElementById('taskForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('taskName').value.trim();
        const desc = document.getElementById('taskDescription').value.trim();
        if (!name) {
            showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏', 'error');
            return;
        }
        if (editingTaskId) {
            await updateTask(editingTaskId, name, desc);
        } else {
            await createTask(name, desc);
        }
    });

    // ==================== –ó–ê–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–û–ö –ü–û –ö–õ–ò–ö–£ –í–ù–ï ====================
    window.onclick = function(e) {
        const timerModal = document.getElementById('timerModal');
        const apiModal = document.getElementById('apiUrlModal');
        if (e.target === timerModal) closeTimerModal();
        if (e.target === apiModal) closeApiUrlModal();
    };
</script>
</body>
</html>
